# Tree ç»„ä»¶å¤åˆ»æ­¥éª¤

> æœ¬æ–‡æ¡£åŸºäº **æ¶æ„ + æ•°æ®ç»“æ„ + ç»éªŒ** å…¬å¼ï¼Œæä¾›æ¸è¿›å¼çš„ Tree ç»„ä»¶å¤åˆ»å®ç°è·¯å¾„ã€‚

---

## å¤åˆ»åŸåˆ™

1. **å¾ªåºæ¸è¿›**ï¼šä»ç®€å•åˆ°å¤æ‚ï¼Œæ¯ä¸€æ­¥éƒ½æœ‰å¯è¿è¡Œçš„æˆæœ
2. **æ¶æ„ä¼˜å…ˆ**ï¼šå…ˆæ­å»ºåˆ†å±‚æ¶æ„ï¼Œå†å¡«å……åŠŸèƒ½ç»†èŠ‚
3. **æ•°æ®é©±åŠ¨**ï¼šå…ˆå®ç°æ•°æ®æ¨¡å‹ï¼Œå†å®ç°è§†å›¾æ¸²æŸ“
4. **æµ‹è¯•éªŒè¯**ï¼šæ¯å®Œæˆä¸€æ­¥ï¼Œå¿…é¡»é€šè¿‡åŠŸèƒ½éªŒè¯

---

## Step 1: æ­å»ºé¡¹ç›®åŸºç¡€æ¶æ„ï¼ˆæ•°æ®ç»“æ„ - ç›®å½•ç»“æ„ï¼‰

### ğŸ“‹ æœ¬æ­¥ç›®æ ‡
åˆ›å»º Tree ç»„ä»¶çš„ç›®å½•ç»“æ„å’Œæ–‡ä»¶éª¨æ¶ï¼Œå»ºç«‹æ¸…æ™°çš„åˆ†å±‚æ¶æ„ã€‚

### âœ… è¦è¾¾åˆ°çš„æ•ˆæœ
- å®Œæˆä¸‰å±‚æ¶æ„çš„ç›®å½•åˆ’åˆ†ï¼ˆè§†å›¾å±‚ã€æ•°æ®æ¨¡å‹å±‚ã€å·¥å…·å±‚ï¼‰
- æ‰€æœ‰æ–‡ä»¶åˆ›å»ºå®Œæˆï¼Œä½†åªåŒ…å«åŸºæœ¬éª¨æ¶ä»£ç 
- ç»„ä»¶å¯ä»¥åœ¨é¡µé¢ä¸­å¼•å…¥ï¼Œä½†æš‚æ—¶åªæ˜¾ç¤ºä¸€ä¸ªç©ºçš„ div

### ğŸ¯ è¯¥åšä»€ä¹ˆ
1. **åˆ›å»ºç›®å½•ç»“æ„**ï¼š
   ```
   tree/
   â”œâ”€â”€ index.js                    # å…¥å£æ–‡ä»¶
   â”œâ”€â”€ src/
   â”‚   â”œâ”€â”€ tree.vue               # æ ‘å®¹å™¨ç»„ä»¶
   â”‚   â”œâ”€â”€ tree-node.vue          # æ ‘èŠ‚ç‚¹ç»„ä»¶
   â”‚   â””â”€â”€ model/
   â”‚       â”œâ”€â”€ node.js            # Node ç±»
   â”‚       â”œâ”€â”€ tree-store.js      # TreeStore ç±»
   â”‚       â””â”€â”€ util.js            # å·¥å…·å‡½æ•°
   ```

2. **åˆ›å»º index.js**ï¼š
   ```javascript
   import Tree from './src/tree.vue';
   
   Tree.install = function(Vue) {
     Vue.component(Tree.name, Tree);
   };
   
   export default Tree;
   ```

3. **åˆ›å»º tree.vue éª¨æ¶**ï¼š
   ```vue
   <template>
     <div class="el-tree" role="tree">
       <!-- å¾…å®ç° -->
     </div>
   </template>
   
   <script>
   export default {
     name: 'ElTree',
     props: {
       data: Array
     },
     data() {
       return {
         store: null,
         root: null
       };
     }
   };
   </script>
   ```

4. **åˆ›å»º tree-node.vue éª¨æ¶**ï¼š
   ```vue
   <template>
     <div class="el-tree-node" role="treeitem">
       <!-- å¾…å®ç° -->
     </div>
   </template>
   
   <script>
   export default {
     name: 'ElTreeNode',
     props: {
       node: Object
     }
   };
   </script>
   ```

5. **åˆ›å»ºç©ºçš„ model æ–‡ä»¶**ï¼š
   ```javascript
   // model/node.js
   export default class Node {}
   
   // model/tree-store.js
   export default class TreeStore {}
   
   // model/util.js
   export const getNodeKey = function() {};
   ```

### âŒ ä¸è¯¥åšä»€ä¹ˆ
- âŒ ä¸è¦å®ç°ä»»ä½•ä¸šåŠ¡é€»è¾‘
- âŒ ä¸è¦æ·»åŠ æ ·å¼ä»£ç 
- âŒ ä¸è¦å¤„ç†æ•°æ®è½¬æ¢
- âŒ ä¸è¦è€ƒè™‘æ€§èƒ½ä¼˜åŒ–

### ğŸŒ¿ åˆ†æ”¯å‘½å
```bash
git checkout -b feature/tree-step1-architecture
```

### âœ”ï¸ éªŒæ”¶æ ‡å‡†
- [ ] ç›®å½•ç»“æ„å®Œæ•´ï¼Œç¬¦åˆä¸‰å±‚æ¶æ„
- [ ] æ‰€æœ‰æ–‡ä»¶å·²åˆ›å»ºï¼Œæ— è¯­æ³•é”™è¯¯
- [ ] ç»„ä»¶å¯ä»¥åœ¨æµ‹è¯•é¡µé¢ä¸­å¼•å…¥å¹¶æ¸²æŸ“ï¼ˆæ˜¾ç¤ºç©º divï¼‰
- [ ] ä»£ç é€šè¿‡ ESLint æ£€æŸ¥

---

## Step 2: å®ç° Node æ•°æ®æ¨¡å‹ï¼ˆæ•°æ®ç»“æ„ - Node ç±»ï¼‰

### ğŸ“‹ æœ¬æ­¥ç›®æ ‡
å®ç° Node ç±»ï¼Œæ„å»ºæ ‘èŠ‚ç‚¹çš„æ•°æ®æ¨¡å‹ï¼Œå»ºç«‹çˆ¶å­åŒå‘å¼•ç”¨å…³ç³»ã€‚

### âœ… è¦è¾¾åˆ°çš„æ•ˆæœ
- Node ç±»å¯ä»¥åˆ›å»ºèŠ‚ç‚¹å®ä¾‹
- èŠ‚ç‚¹å…·å¤‡åŸºæœ¬å±æ€§ï¼ˆid, level, data, parent, childNodesï¼‰
- å¯ä»¥é€šè¿‡ setData æ–¹æ³•é€’å½’åˆ›å»ºå­èŠ‚ç‚¹
- èŠ‚ç‚¹å…·å¤‡åŸºæœ¬æ“ä½œæ–¹æ³•ï¼ˆexpand, collapse, insertChild, removeï¼‰

### ğŸ¯ è¯¥åšä»€ä¹ˆ
1. **å®ç° Node ç±»æ„é€ å‡½æ•°**ï¼š
   ```javascript
   let nodeIdSeed = 0;
   
   export default class Node {
     constructor(options) {
       // åŸºæœ¬å±æ€§
       this.id = nodeIdSeed++;
       this.text = null;
       this.data = null;
       this.parent = null;
       this.level = 0;
       this.childNodes = [];
       
       // çŠ¶æ€å±æ€§ï¼ˆå…ˆå£°æ˜ï¼Œæš‚ä¸å®ç°é€»è¾‘ï¼‰
       this.expanded = false;
       this.visible = true;
       this.checked = false;
       this.indeterminate = false;
       this.isCurrent = false;
       this.isLeaf = false;
       
       // æ‡’åŠ è½½ç›¸å…³
       this.loaded = false;
       this.loading = false;
       
       // å¤åˆ¶ options å±æ€§
       for (let name in options) {
         if (options.hasOwnProperty(name)) {
           this[name] = options[name];
         }
       }
       
       // è®¡ç®—å±‚çº§
       if (this.parent) {
         this.level = this.parent.level + 1;
       }
       
       // æ³¨å†Œåˆ° store
       const store = this.store;
       if (!store) {
         throw new Error('[Node]store is required!');
       }
       store.registerNode(this);
       
       // è®¾ç½®æ•°æ®ï¼ˆå¦‚æœä¸æ˜¯æ‡’åŠ è½½ï¼‰
       if (store.lazy !== true && this.data) {
         this.setData(this.data);
       }
       
       this.updateLeafState();
     }
   }
   ```

2. **å®ç° setData æ–¹æ³•**ï¼ˆé€’å½’åˆ›å»ºå­èŠ‚ç‚¹ï¼‰ï¼š
   ```javascript
   setData(data) {
     this.data = data;
     this.childNodes = [];
     
     let children;
     if (this.level === 0 && this.data instanceof Array) {
       children = this.data;  // æ ¹èŠ‚ç‚¹çš„ data å°±æ˜¯æ•°ç»„
     } else {
       // ä»é…ç½®ä¸­è·å– children å­—æ®µ
       const childrenKey = this.store.props?.children || 'children';
       children = data[childrenKey] || [];
     }
     
     // é€’å½’åˆ›å»ºå­èŠ‚ç‚¹
     for (let i = 0, j = children.length; i < j; i++) {
       this.insertChild({ data: children[i] });
     }
   }
   ```

3. **å®ç°èŠ‚ç‚¹æ“ä½œæ–¹æ³•**ï¼š
   ```javascript
   // æ’å…¥å­èŠ‚ç‚¹
   insertChild(child, index) {
     if (!child) throw new Error('insertChild error: child is required.');
     
     if (!(child instanceof Node)) {
       Object.assign(child, {
         parent: this,
         store: this.store
       });
       child = new Node(child);
     }
     
     child.level = this.level + 1;
     
     if (typeof index === 'undefined' || index < 0) {
       this.childNodes.push(child);
     } else {
       this.childNodes.splice(index, 0, child);
     }
     
     this.updateLeafState();
   }
   
   // ç§»é™¤èŠ‚ç‚¹
   remove() {
     const parent = this.parent;
     if (parent) {
       parent.removeChild(this);
     }
   }
   
   removeChild(child) {
     const index = this.childNodes.indexOf(child);
     if (index > -1) {
       this.store && this.store.deregisterNode(child);
       child.parent = null;
       this.childNodes.splice(index, 1);
     }
     this.updateLeafState();
   }
   
   // å±•å¼€æ”¶èµ·ï¼ˆæš‚æ—¶åªä¿®æ”¹çŠ¶æ€ï¼‰
   expand() {
     this.expanded = true;
   }
   
   collapse() {
     this.expanded = false;
   }
   
   // æ›´æ–°å¶å­èŠ‚ç‚¹çŠ¶æ€
   updateLeafState() {
     this.isLeaf = this.childNodes.length === 0;
   }
   ```

4. **å®ç°åŠ¨æ€å±æ€§ getter**ï¼š
   ```javascript
   get label() {
     const labelKey = this.store.props?.label || 'label';
     return this.data?.[labelKey];
   }
   
   get key() {
     const nodeKey = this.store.key;
     if (this.data) return this.data[nodeKey];
     return null;
   }
   ```

### âŒ ä¸è¯¥åšä»€ä¹ˆ
- âŒ ä¸è¦å®ç°å¤é€‰æ¡†é€»è¾‘ï¼ˆsetCheckedï¼‰
- âŒ ä¸è¦å®ç°æ‡’åŠ è½½é€»è¾‘ï¼ˆloadDataï¼‰
- âŒ ä¸è¦å®ç°èŠ‚ç‚¹è¿‡æ»¤åŠŸèƒ½
- âŒ ä¸è¦å¤„ç†äº‹ä»¶è§¦å‘

### ğŸŒ¿ åˆ†æ”¯å‘½å
```bash
git checkout -b feature/tree-step2-node-model
```

### âœ”ï¸ éªŒæ”¶æ ‡å‡†
- [ ] å¯ä»¥åˆ›å»º Node å®ä¾‹ï¼ŒåŒ…å«å®Œæ•´å±æ€§
- [ ] setData å¯ä»¥é€’å½’åˆ›å»ºå­èŠ‚ç‚¹æ ‘
- [ ] çˆ¶å­èŠ‚ç‚¹æ­£ç¡®å»ºç«‹åŒå‘å¼•ç”¨ï¼ˆparent å’Œ childNodesï¼‰
- [ ] èŠ‚ç‚¹å±‚çº§ï¼ˆlevelï¼‰è®¡ç®—æ­£ç¡®
- [ ] insertChild å’Œ remove æ–¹æ³•å·¥ä½œæ­£å¸¸
- [ ] é€šè¿‡å•å…ƒæµ‹è¯•éªŒè¯åŸºæœ¬åŠŸèƒ½

---

## Step 3: å®ç° TreeStore çŠ¶æ€ç®¡ç†ï¼ˆæ•°æ®ç»“æ„ - TreeStore ç±»ï¼‰

### ğŸ“‹ æœ¬æ­¥ç›®æ ‡
å®ç° TreeStore ç±»ï¼Œä½œä¸ºå…¨å±€çŠ¶æ€ç®¡ç†ä¸­å¿ƒï¼Œç®¡ç†æ‰€æœ‰èŠ‚ç‚¹å®ä¾‹ã€‚

### âœ… è¦è¾¾åˆ°çš„æ•ˆæœ
- TreeStore å¯ä»¥æ¥æ”¶é…ç½®å‚æ•°å¹¶åˆå§‹åŒ–
- åˆ›å»ºæ ¹èŠ‚ç‚¹ï¼ˆrootï¼‰ï¼Œå¹¶é€’å½’åˆ›å»ºæ•´æ£µæ ‘
- ç»´æŠ¤ nodesMap æ˜ å°„è¡¨ï¼Œå®ç°å¿«é€ŸèŠ‚ç‚¹æŸ¥æ‰¾
- æä¾›èŠ‚ç‚¹çš„å¢åˆ æ”¹æŸ¥æ–¹æ³•

### ğŸ¯ è¯¥åšä»€ä¹ˆ
1. **å®ç° TreeStore æ„é€ å‡½æ•°**ï¼š
   ```javascript
   import Node from './node';
   import { getNodeKey } from './util';
   
   export default class TreeStore {
     constructor(options) {
       this.currentNode = null;
       this.currentNodeKey = null;
       
       // å¤åˆ¶é…ç½®
       for (let option in options) {
         if (options.hasOwnProperty(option)) {
           this[option] = options[option];
         }
       }
       
       // èŠ‚ç‚¹æ˜ å°„è¡¨
       this.nodesMap = {};
       
       // åˆ›å»ºæ ¹èŠ‚ç‚¹
       this.root = new Node({
         data: this.data,
         store: this
       });
     }
   }
   ```

2. **å®ç°èŠ‚ç‚¹æ³¨å†Œå’Œæ³¨é”€**ï¼š
   ```javascript
   registerNode(node) {
     const key = this.key;
     if (!key || !node || !node.data) return;
     
     const nodeKey = node.key;
     if (nodeKey !== undefined) {
       this.nodesMap[node.key] = node;
     }
   }
   
   deregisterNode(node) {
     const key = this.key;
     if (!key || !node || !node.data) return;
     
     // é€’å½’æ³¨é”€å­èŠ‚ç‚¹
     node.childNodes.forEach(child => {
       this.deregisterNode(child);
     });
     
     delete this.nodesMap[node.key];
   }
   ```

3. **å®ç°èŠ‚ç‚¹æŸ¥æ‰¾**ï¼š
   ```javascript
   getNode(data) {
     if (data instanceof Node) return data;
     const key = typeof data !== 'object' ? data : getNodeKey(this.key, data);
     return this.nodesMap[key] || null;
   }
   ```

4. **å®ç°èŠ‚ç‚¹å¢åˆ æ“ä½œ**ï¼š
   ```javascript
   append(data, parentData) {
     const parentNode = parentData ? this.getNode(parentData) : this.root;
     if (parentNode) {
       parentNode.insertChild({ data });
     }
   }
   
   insertBefore(data, refData) {
     const refNode = this.getNode(refData);
     refNode.parent.insertBefore({ data }, refNode);
   }
   
   insertAfter(data, refData) {
     const refNode = this.getNode(refData);
     refNode.parent.insertAfter({ data }, refNode);
   }
   
   remove(data) {
     const node = this.getNode(data);
     if (node && node.parent) {
       if (node === this.currentNode) {
         this.currentNode = null;
       }
       node.parent.removeChild(node);
     }
   }
   ```

5. **å®ç°æ•°æ®æ›´æ–°**ï¼š
   ```javascript
   setData(newVal) {
     const instanceChanged = newVal !== this.root.data;
     if (instanceChanged) {
       this.root.setData(newVal);
     } else {
       this.root.updateChildren();
     }
   }
   ```

6. **å®ç°å½“å‰èŠ‚ç‚¹ç®¡ç†**ï¼š
   ```javascript
   setCurrentNode(currentNode) {
     const prevCurrentNode = this.currentNode;
     if (prevCurrentNode) {
       prevCurrentNode.isCurrent = false;
     }
     this.currentNode = currentNode;
     this.currentNode.isCurrent = true;
   }
   
   getCurrentNode() {
     return this.currentNode;
   }
   
   setCurrentNodeKey(key) {
     if (key === null || key === undefined) {
       this.currentNode && (this.currentNode.isCurrent = false);
       this.currentNode = null;
       return;
     }
     const node = this.getNode(key);
     if (node) {
       this.setCurrentNode(node);
     }
   }
   ```

### âŒ ä¸è¯¥åšä»€ä¹ˆ
- âŒ ä¸è¦å®ç°å¤é€‰æ¡†ç›¸å…³æ–¹æ³•ï¼ˆgetCheckedNodesã€setCheckedKeysï¼‰
- âŒ ä¸è¦å®ç°è¿‡æ»¤åŠŸèƒ½ï¼ˆfilterï¼‰
- âŒ ä¸è¦å®ç°æ‡’åŠ è½½é€»è¾‘
- âŒ ä¸è¦å®ç°é»˜è®¤å±•å¼€/é€‰ä¸­çš„åˆå§‹åŒ–

### ğŸŒ¿ åˆ†æ”¯å‘½å
```bash
git checkout -b feature/tree-step3-tree-store
```

### âœ”ï¸ éªŒæ”¶æ ‡å‡†
- [ ] TreeStore å¯ä»¥æ¥æ”¶é…ç½®å¹¶æ­£ç¡®åˆå§‹åŒ–
- [ ] root èŠ‚ç‚¹åˆ›å»ºæˆåŠŸï¼Œæ ‘ç»“æ„æ­£ç¡®
- [ ] nodesMap æ­£ç¡®ç»´æŠ¤æ‰€æœ‰èŠ‚ç‚¹å¼•ç”¨
- [ ] getNode å¯ä»¥é€šè¿‡ key æˆ– data å¿«é€ŸæŸ¥æ‰¾èŠ‚ç‚¹ï¼ˆO(1) å¤æ‚åº¦ï¼‰
- [ ] appendã€remove ç­‰æ“ä½œæ­£å¸¸å·¥ä½œ
- [ ] é€šè¿‡å•å…ƒæµ‹è¯•éªŒè¯æ•°æ®æ¨¡å‹å®Œæ•´æ€§

---

## Step 4: å®ç°å·¥å…·å‡½æ•°ï¼ˆæ•°æ®ç»“æ„ - util.jsï¼‰

### ğŸ“‹ æœ¬æ­¥ç›®æ ‡
å®ç°é€šç”¨å·¥å…·å‡½æ•°ï¼Œä¸ºæ•°æ®æ¨¡å‹å’Œè§†å›¾å±‚æä¾›æ”¯æŒã€‚

### âœ… è¦è¾¾åˆ°çš„æ•ˆæœ
- èŠ‚ç‚¹æ ‡è®°åŠŸèƒ½ï¼ˆmarkNodeDataï¼‰
- èŠ‚ç‚¹ key è·å–ï¼ˆgetNodeKeyï¼‰
- ç»„ä»¶æŸ¥æ‰¾å·¥å…·ï¼ˆfindNearestComponentï¼‰

### ğŸ¯ è¯¥åšä»€ä¹ˆ
1. **å®ç°èŠ‚ç‚¹æ ‡è®°**ï¼š
   ```javascript
   export const NODE_KEY = '$treeNodeId';
   
   export const markNodeData = function(node, data) {
     if (!data || data[NODE_KEY]) return;
     Object.defineProperty(data, NODE_KEY, {
       value: node.id,
       enumerable: false,      // ä¸å¯æšä¸¾
       configurable: false,    // ä¸å¯é…ç½®
       writable: false         // ä¸å¯å†™
     });
   };
   ```

2. **å®ç° key è·å–**ï¼š
   ```javascript
   export const getNodeKey = function(key, data) {
     if (!key) return data[NODE_KEY];
     return data[key];
   };
   ```

3. **å®ç°ç»„ä»¶æŸ¥æ‰¾**ï¼ˆç”¨äºæ‹–æ‹½ï¼‰ï¼š
   ```javascript
   export const findNearestComponent = (element, componentName) => {
     let target = element;
     while (target && target.tagName !== 'BODY') {
       if (target.__vue__ && target.__vue__.$options.name === componentName) {
         return target.__vue__;
       }
       target = target.parentNode;
     }
     return null;
   };
   ```

4. **åœ¨ Node æ„é€ å‡½æ•°ä¸­è°ƒç”¨ markNodeData**ï¼š
   ```javascript
   // node.js
   import { markNodeData, NODE_KEY } from './util';
   
   constructor(options) {
     // ... å…¶ä»–ä»£ç 
     if (!Array.isArray(this.data)) {
       markNodeData(this, this.data);
     }
   }
   ```

### âŒ ä¸è¯¥åšä»€ä¹ˆ
- âŒ ä¸è¦æ·»åŠ ä¸å¿…è¦çš„å·¥å…·å‡½æ•°
- âŒ ä¸è¦åœ¨å·¥å…·å‡½æ•°ä¸­å¤„ç†ä¸šåŠ¡é€»è¾‘

### ğŸŒ¿ åˆ†æ”¯å‘½å
```bash
git checkout -b feature/tree-step4-utils
```

### âœ”ï¸ éªŒæ”¶æ ‡å‡†
- [ ] markNodeData æ­£ç¡®ä¸ºæ•°æ®å¯¹è±¡æ·»åŠ ä¸å¯æšä¸¾çš„èŠ‚ç‚¹ ID
- [ ] getNodeKey å¯ä»¥æ ¹æ®é…ç½®è·å–èŠ‚ç‚¹å”¯ä¸€æ ‡è¯†
- [ ] findNearestComponent å¯ä»¥æŸ¥æ‰¾æœ€è¿‘çš„ Vue ç»„ä»¶å®ä¾‹
- [ ] é€šè¿‡å•å…ƒæµ‹è¯•éªŒè¯å·¥å…·å‡½æ•°

---

## Step 5: å®ç°åŸºç¡€æ ‘æ¸²æŸ“ï¼ˆæ¶æ„ - é€’å½’ç»„ä»¶ï¼‰

### ğŸ“‹ æœ¬æ­¥ç›®æ ‡
å°†æ•°æ®æ¨¡å‹ä¸è§†å›¾å±‚è¿æ¥ï¼Œå®ç°æ ‘çš„åŸºç¡€æ¸²æŸ“ï¼Œå±•ç¤ºæ ‘å½¢ç»“æ„ã€‚

### âœ… è¦è¾¾åˆ°çš„æ•ˆæœ
- tree.vue åˆ›å»º TreeStore å®ä¾‹å¹¶æ¸²æŸ“æ ¹èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
- tree-node.vue é€’å½’æ¸²æŸ“èŠ‚ç‚¹ï¼Œæ˜¾ç¤ºèŠ‚ç‚¹æ–‡æœ¬
- æ ‘å½¢ç»“æ„æ­£ç¡®æ˜¾ç¤ºï¼Œå±‚çº§ç¼©è¿›æ¸…æ™°

### ğŸ¯ è¯¥åšä»€ä¹ˆ
1. **å®Œå–„ tree.vue**ï¼š
   ```vue
   <template>
     <div class="el-tree" role="tree">
       <el-tree-node
         v-for="child in root.childNodes"
         :node="child"
         :props="props"
         :key="getNodeKey(child)"
       ></el-tree-node>
       
       <div class="el-tree__empty-block" v-if="isEmpty">
         <span class="el-tree__empty-text">{{ emptyText }}</span>
       </div>
     </div>
   </template>
   
   <script>
   import TreeStore from './model/tree-store';
   import { getNodeKey } from './model/util';
   import ElTreeNode from './tree-node.vue';
   
   export default {
     name: 'ElTree',
     
     components: {
       ElTreeNode
     },
     
     props: {
       data: {
         type: Array
       },
       emptyText: {
         type: String,
         default: 'æš‚æ— æ•°æ®'
       },
       nodeKey: String,
       props: {
         default() {
           return {
             children: 'children',
             label: 'label',
             disabled: 'disabled'
           };
         }
       },
       defaultExpandAll: Boolean
     },
     
     data() {
       return {
         store: null,
         root: null
       };
     },
     
     computed: {
       isEmpty() {
         const { childNodes } = this.root;
         return !childNodes || childNodes.length === 0;
       }
     },
     
     methods: {
       getNodeKey(node) {
         return getNodeKey(this.nodeKey, node.data);
       }
     },
     
     created() {
       this.isTree = true;
       
       this.store = new TreeStore({
         key: this.nodeKey,
         data: this.data,
         props: this.props,
         defaultExpandAll: this.defaultExpandAll
       });
       
       this.root = this.store.root;
     }
   };
   </script>
   ```

2. **å®Œå–„ tree-node.vue**ï¼ˆé€’å½’æ¸²æŸ“ï¼‰ï¼š
   ```vue
   <template>
     <div
       class="el-tree-node"
       v-show="node.visible"
       :class="{
         'is-expanded': expanded,
         'is-current': node.isCurrent,
         'is-hidden': !node.visible
       }"
       role="treeitem"
     >
       <div 
         class="el-tree-node__content"
         :style="{ 'padding-left': (node.level - 1) * 18 + 'px' }"
       >
         <!-- å±•å¼€å›¾æ ‡ -->
         <span
           :class="[
             { 'is-leaf': node.isLeaf, expanded: !node.isLeaf && expanded },
             'el-tree-node__expand-icon',
             'el-icon-caret-right'
           ]"
         ></span>
         
         <!-- èŠ‚ç‚¹æ–‡æœ¬ -->
         <span class="el-tree-node__label">{{ node.label }}</span>
       </div>
       
       <!-- é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹ -->
       <div
         class="el-tree-node__children"
         v-show="expanded"
         role="group"
       >
         <el-tree-node
           v-for="child in node.childNodes"
           :node="child"
           :key="getNodeKey(child)"
         ></el-tree-node>
       </div>
     </div>
   </template>
   
   <script>
   import { getNodeKey } from './model/util';
   
   export default {
     name: 'ElTreeNode',
     
     props: {
       node: {
         default() {
           return {};
         }
       }
     },
     
     data() {
       return {
         tree: null,
         expanded: false
       };
     },
     
     watch: {
       'node.expanded'(val) {
         this.$nextTick(() => this.expanded = val);
       }
     },
     
     methods: {
       getNodeKey(node) {
         return getNodeKey(this.tree.nodeKey, node.data);
       }
     },
     
     created() {
       const parent = this.$parent;
       
       // å‘ä¸ŠæŸ¥æ‰¾ tree æ ¹ç»„ä»¶
       if (parent.isTree) {
         this.tree = parent;
       } else {
         this.tree = parent.tree;
       }
       
       // åŒæ­¥å±•å¼€çŠ¶æ€
       if (this.node.expanded) {
         this.expanded = true;
       }
     }
   };
   </script>
   ```

3. **å¤„ç† defaultExpandAll**ï¼š
   ```javascript
   // node.js - constructor ä¸­
   if (store.defaultExpandAll) {
     this.expanded = true;
   }
   ```

### âŒ ä¸è¯¥åšä»€ä¹ˆ
- âŒ ä¸è¦å®ç°ç‚¹å‡»äº¤äº’
- âŒ ä¸è¦å®ç°å±•å¼€/æ”¶èµ·åŠ¨ç”»
- âŒ ä¸è¦å®ç°å¤é€‰æ¡†
- âŒ ä¸è¦å¤„ç†æ‹–æ‹½

### ğŸŒ¿ åˆ†æ”¯å‘½å
```bash
git checkout -b feature/tree-step5-basic-render
```

### âœ”ï¸ éªŒæ”¶æ ‡å‡†
- [ ] æ ‘å½¢ç»“æ„æ­£ç¡®æ¸²æŸ“åœ¨é¡µé¢ä¸Š
- [ ] èŠ‚ç‚¹å±‚çº§ç¼©è¿›æ­£ç¡®ï¼ˆæ¯å±‚ 18pxï¼‰
- [ ] èŠ‚ç‚¹æ–‡æœ¬æ­£ç¡®æ˜¾ç¤ºï¼ˆæ”¯æŒè‡ªå®šä¹‰ label å­—æ®µï¼‰
- [ ] defaultExpandAll é…ç½®ç”Ÿæ•ˆ
- [ ] ç©ºæ•°æ®æ—¶æ˜¾ç¤º"æš‚æ— æ•°æ®"æç¤º
- [ ] é€’å½’ç»„ä»¶å·¥ä½œæ­£å¸¸ï¼Œæ”¯æŒä»»æ„å±‚çº§

---

## Step 6: å®ç°å±•å¼€æ”¶èµ·åŠŸèƒ½ï¼ˆæ¶æ„ - äº¤äº’é€»è¾‘ï¼‰

### ğŸ“‹ æœ¬æ­¥ç›®æ ‡
å®ç°èŠ‚ç‚¹çš„å±•å¼€/æ”¶èµ·äº¤äº’ï¼Œå¢åŠ å±•å¼€æ”¶èµ·åŠ¨ç”»æ•ˆæœã€‚

### âœ… è¦è¾¾åˆ°çš„æ•ˆæœ
- ç‚¹å‡»å±•å¼€å›¾æ ‡å¯ä»¥å±•å¼€/æ”¶èµ·å­èŠ‚ç‚¹
- å±•å¼€æ”¶èµ·å¸¦æœ‰åŠ¨ç”»è¿‡æ¸¡æ•ˆæœ
- æ”¯æŒ expandOnClickNode é…ç½®ï¼ˆç‚¹å‡»èŠ‚ç‚¹å†…å®¹ä¹Ÿå¯ä»¥å±•å¼€ï¼‰
- è§¦å‘ node-expand å’Œ node-collapse äº‹ä»¶

### ğŸ¯ è¯¥åšä»€ä¹ˆ
1. **æ·»åŠ å±•å¼€å›¾æ ‡ç‚¹å‡»äº‹ä»¶**ï¼š
   ```vue
   <!-- tree-node.vue -->
   <span
     @click.stop="handleExpandIconClick"
     :class="[
       { 'is-leaf': node.isLeaf, expanded: !node.isLeaf && expanded },
       'el-tree-node__expand-icon',
       'el-icon-caret-right'
     ]"
   ></span>
   ```

2. **å®ç°å±•å¼€æ”¶èµ·é€»è¾‘**ï¼š
   ```javascript
   // tree-node.vue
   methods: {
     handleExpandIconClick() {
       if (this.node.isLeaf) return;
       
       if (this.expanded) {
         this.tree.$emit('node-collapse', this.node.data, this.node, this);
         this.node.collapse();
       } else {
         this.node.expand();
         this.$emit('node-expand', this.node.data, this.node, this);
       }
     }
   }
   ```

3. **æ·»åŠ æŠ˜å åŠ¨ç”»ç»„ä»¶**ï¼š
   ```vue
   <!-- tree-node.vue -->
   <el-collapse-transition>
     <div
       class="el-tree-node__children"
       v-show="expanded"
       role="group"
     >
       <el-tree-node
         v-for="child in node.childNodes"
         :node="child"
         :key="getNodeKey(child)"
       ></el-tree-node>
     </div>
   </el-collapse-transition>
   ```

4. **åœ¨ tree.vue ä¸­ç›‘å¬å¹¶è½¬å‘äº‹ä»¶**ï¼š
   ```javascript
   // tree.vue
   props: {
     expandOnClickNode: {
       type: Boolean,
       default: true
     }
   },
   
   methods: {
     handleNodeExpand(nodeData, node, instance) {
       this.$emit('node-expand', nodeData, node, instance);
     }
   }
   ```

5. **æ·»åŠ èŠ‚ç‚¹å†…å®¹ç‚¹å‡»**ï¼š
   ```vue
   <!-- tree-node.vue -->
   <div 
     class="el-tree-node__content"
     @click.stop="handleClick"
     :style="{ 'padding-left': (node.level - 1) * 18 + 'px' }"
   >
   ```

   ```javascript
   methods: {
     handleClick() {
       if (this.tree.expandOnClickNode) {
         this.handleExpandIconClick();
       }
     }
   }
   ```

### âŒ ä¸è¯¥åšä»€ä¹ˆ
- âŒ ä¸è¦å®ç°æ‰‹é£ç´æ¨¡å¼ï¼ˆaccordionï¼‰
- âŒ ä¸è¦å®ç°å»¶è¿Ÿæ¸²æŸ“ï¼ˆrenderAfterExpandï¼‰
- âŒ ä¸è¦å®ç°é»˜è®¤å±•å¼€èŠ‚ç‚¹ï¼ˆdefaultExpandedKeysï¼‰

### ğŸŒ¿ åˆ†æ”¯å‘½å
```bash
git checkout -b feature/tree-step6-expand-collapse
```

### âœ”ï¸ éªŒæ”¶æ ‡å‡†
- [ ] ç‚¹å‡»å±•å¼€å›¾æ ‡å¯ä»¥å±•å¼€/æ”¶èµ·èŠ‚ç‚¹
- [ ] å±•å¼€æ”¶èµ·æœ‰åŠ¨ç”»æ•ˆæœ
- [ ] expandOnClickNode é…ç½®ç”Ÿæ•ˆ
- [ ] node-expand å’Œ node-collapse äº‹ä»¶æ­£å¸¸è§¦å‘
- [ ] å¶å­èŠ‚ç‚¹ä¸æ˜¾ç¤ºå±•å¼€å›¾æ ‡

---

## Step 7: å®ç°èŠ‚ç‚¹é€‰ä¸­é«˜äº®ï¼ˆæ¶æ„ - çŠ¶æ€ç®¡ç†ï¼‰

### ğŸ“‹ æœ¬æ­¥ç›®æ ‡
å®ç°èŠ‚ç‚¹çš„ç‚¹å‡»é€‰ä¸­åŠŸèƒ½ï¼Œå½“å‰é€‰ä¸­çš„èŠ‚ç‚¹é«˜äº®æ˜¾ç¤ºã€‚

### âœ… è¦è¾¾åˆ°çš„æ•ˆæœ
- ç‚¹å‡»èŠ‚ç‚¹å¯ä»¥é€‰ä¸­è¯¥èŠ‚ç‚¹
- é€‰ä¸­çš„èŠ‚ç‚¹èƒŒæ™¯é«˜äº®
- æ”¯æŒ highlightCurrent é…ç½®æ§åˆ¶æ˜¯å¦é«˜äº®
- æ”¯æŒ currentNodeKey é…ç½®é»˜è®¤é€‰ä¸­èŠ‚ç‚¹
- æä¾› setCurrentKeyã€getCurrentKey ç­‰ API

### ğŸ¯ è¯¥åšä»€ä¹ˆ
1. **æ·»åŠ  props é…ç½®**ï¼š
   ```javascript
   // tree.vue
   props: {
     highlightCurrent: Boolean,
     currentNodeKey: [String, Number]
   },
   
   data() {
     return {
       store: null,
       root: null,
       currentNode: null
     };
   }
   ```

2. **åœ¨ TreeStore ä¸­åˆå§‹åŒ–å½“å‰èŠ‚ç‚¹**ï¼š
   ```javascript
   // tree-store.js - constructor
   this.currentNodeKey = options.currentNodeKey;
   
   // node.js - constructor
   if (key && store.currentNodeKey !== undefined && this.key === store.currentNodeKey) {
     store.currentNode = this;
     store.currentNode.isCurrent = true;
   }
   ```

3. **å®ç°èŠ‚ç‚¹ç‚¹å‡»é€‰ä¸­**ï¼š
   ```javascript
   // tree-node.vue
   methods: {
     handleClick() {
       const store = this.tree.store;
       store.setCurrentNode(this.node);
       this.tree.$emit('current-change', store.currentNode ? store.currentNode.data : null, store.currentNode);
       this.tree.currentNode = this;
       
       if (this.tree.expandOnClickNode) {
         this.handleExpandIconClick();
       }
       
       this.tree.$emit('node-click', this.node.data, this.node, this);
     }
   }
   ```

4. **æ·»åŠ é«˜äº®æ ·å¼ç±»**ï¼š
   ```vue
   <!-- tree-node.vue -->
   <div
     class="el-tree-node"
     :class="{
       'is-expanded': expanded,
       'is-current': node.isCurrent,
       'is-hidden': !node.visible
     }"
   >
   ```

   ```vue
   <!-- tree.vue -->
   <div
     class="el-tree"
     :class="{
       'el-tree--highlight-current': highlightCurrent
     }"
   >
   ```

5. **æä¾›å¤–éƒ¨ API**ï¼š
   ```javascript
   // tree.vue
   methods: {
     getCurrentNode() {
       const currentNode = this.store.getCurrentNode();
       return currentNode ? currentNode.data : null;
     },
     
     getCurrentKey() {
       if (!this.nodeKey) throw new Error('[Tree] nodeKey is required in getCurrentKey');
       const currentNode = this.getCurrentNode();
       return currentNode ? currentNode[this.nodeKey] : null;
     },
     
     setCurrentNode(node) {
       if (!this.nodeKey) throw new Error('[Tree] nodeKey is required in setCurrentNode');
       this.store.setUserCurrentNode(node);
     },
     
     setCurrentKey(key) {
       if (!this.nodeKey) throw new Error('[Tree] nodeKey is required in setCurrentKey');
       this.store.setCurrentNodeKey(key);
     },
     
     getNode(data) {
       return this.store.getNode(data);
     }
   }
   ```

6. **åœ¨ TreeStore ä¸­å®ç°è¾…åŠ©æ–¹æ³•**ï¼š
   ```javascript
   // tree-store.js
   setUserCurrentNode(node) {
     const key = node[this.key];
     const currNode = this.nodesMap[key];
     this.setCurrentNode(currNode);
   }
   ```

### âŒ ä¸è¯¥åšä»€ä¹ˆ
- âŒ ä¸è¦å®ç°å¤šé€‰åŠŸèƒ½
- âŒ ä¸è¦å®ç°å³é”®èœå•
- âŒ ä¸è¦å®ç°èŠ‚ç‚¹ç¼–è¾‘

### ğŸŒ¿ åˆ†æ”¯å‘½å
```bash
git checkout -b feature/tree-step7-node-select
```

### âœ”ï¸ éªŒæ”¶æ ‡å‡†
- [ ] ç‚¹å‡»èŠ‚ç‚¹å¯ä»¥é€‰ä¸­å¹¶é«˜äº®
- [ ] highlightCurrent é…ç½®ç”Ÿæ•ˆ
- [ ] currentNodeKey å¯ä»¥è®¾ç½®é»˜è®¤é€‰ä¸­èŠ‚ç‚¹
- [ ] current-change å’Œ node-click äº‹ä»¶æ­£å¸¸è§¦å‘
- [ ] setCurrentKeyã€getCurrentKey ç­‰ API å·¥ä½œæ­£å¸¸

---

## Step 8: å®ç°å¤é€‰æ¡†åŠŸèƒ½ï¼ˆç»éªŒ - çº§è”é€‰æ‹©ç®—æ³•ï¼‰

### ğŸ“‹ æœ¬æ­¥ç›®æ ‡
å®ç°èŠ‚ç‚¹å¤é€‰æ¡†åŠŸèƒ½ï¼ŒåŒ…å«çˆ¶å­çº§è”é€‰æ‹©é€»è¾‘ã€‚

### âœ… è¦è¾¾åˆ°çš„æ•ˆæœ
- èŠ‚ç‚¹å‰æ˜¾ç¤ºå¤é€‰æ¡†
- å‹¾é€‰çˆ¶èŠ‚ç‚¹ï¼Œå­èŠ‚ç‚¹å…¨éƒ¨å‹¾é€‰
- å‹¾é€‰æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹è‡ªåŠ¨å‹¾é€‰
- éƒ¨åˆ†å­èŠ‚ç‚¹å‹¾é€‰ï¼Œçˆ¶èŠ‚ç‚¹æ˜¾ç¤ºåŠé€‰çŠ¶æ€
- æ”¯æŒ checkStrictly é…ç½®ï¼ˆçˆ¶å­ä¸å…³è”ï¼‰
- æä¾› getCheckedNodesã€setCheckedKeys ç­‰ API

### ğŸ¯ è¯¥åšä»€ä¹ˆ
1. **æ·»åŠ å¤é€‰æ¡†ç›¸å…³ props**ï¼š
   ```javascript
   // tree.vue
   props: {
     showCheckbox: {
       type: Boolean,
       default: false
     },
     checkStrictly: Boolean,
     defaultCheckedKeys: Array
   }
   ```

2. **åœ¨ tree-node.vue ä¸­æ˜¾ç¤ºå¤é€‰æ¡†**ï¼š
   ```vue
   <el-checkbox
     v-if="showCheckbox"
     v-model="node.checked"
     :indeterminate="node.indeterminate"
     :disabled="!!node.disabled"
     @click.native.stop
     @change="handleCheckChange"
   ></el-checkbox>
   ```

   ```javascript
   props: {
     showCheckbox: {
       type: Boolean,
       default: false
     }
   }
   ```

3. **å®ç° getChildState å·¥å…·å‡½æ•°**ï¼š
   ```javascript
   // node.js
   export const getChildState = node => {
     let all = true;
     let none = true;
     let allWithoutDisable = true;
     
     for (let i = 0, j = node.length; i < j; i++) {
       const n = node[i];
       if (n.checked !== true || n.indeterminate) {
         all = false;
         if (!n.disabled) {
           allWithoutDisable = false;
         }
       }
       if (n.checked !== false || n.indeterminate) {
         none = false;
       }
     }
     
     return { all, none, allWithoutDisable, half: !all && !none };
   };
   ```

4. **å®ç°å‘ä¸Šé€’å½’æ›´æ–°çˆ¶èŠ‚ç‚¹çŠ¶æ€**ï¼š
   ```javascript
   // node.js
   const reInitChecked = function(node) {
     if (node.childNodes.length === 0 || node.loading) return;
     
     const { all, none, half } = getChildState(node.childNodes);
     if (all) {
       node.checked = true;
       node.indeterminate = false;
     } else if (half) {
       node.checked = false;
       node.indeterminate = true;
     } else if (none) {
       node.checked = false;
       node.indeterminate = false;
     }
     
     const parent = node.parent;
     if (!parent || parent.level === 0) return;
     
     if (!node.store.checkStrictly) {
       reInitChecked(parent);
     }
   };
   ```

5. **å®ç° setChecked æ–¹æ³•**ï¼ˆå‘ä¸‹çº§è”ï¼‰ï¼š
   ```javascript
   // node.js
   setChecked(value, deep, recursion, passValue) {
     this.indeterminate = value === 'half';
     this.checked = value === true;
     
     if (this.store.checkStrictly) return;
     
     // å‘ä¸‹çº§è”
     if (deep) {
       const childNodes = this.childNodes;
       for (let i = 0, j = childNodes.length; i < j; i++) {
         const child = childNodes[i];
         passValue = passValue || value !== false;
         const isCheck = child.disabled ? child.checked : passValue;
         child.setChecked(isCheck, deep, true, passValue);
       }
       const { half, all } = getChildState(childNodes);
       if (!all) {
         this.checked = all;
         this.indeterminate = half;
       }
     }
     
     // å‘ä¸Šé€’å½’
     const parent = this.parent;
     if (!parent || parent.level === 0) return;
     
     if (!recursion) {
       reInitChecked(parent);
     }
   }
   ```

6. **å¤„ç†å¤é€‰æ¡†å˜åŒ–äº‹ä»¶**ï¼š
   ```javascript
   // tree-node.vue
   methods: {
     handleCheckChange(value, ev) {
       this.node.setChecked(ev.target.checked, !this.tree.checkStrictly);
       this.$nextTick(() => {
         const store = this.tree.store;
         this.tree.$emit('check', this.node.data, {
           checkedNodes: store.getCheckedNodes(),
           checkedKeys: store.getCheckedKeys(),
           halfCheckedNodes: store.getHalfCheckedNodes(),
           halfCheckedKeys: store.getHalfCheckedKeys()
         });
       });
     },
     
     handleSelectChange(checked, indeterminate) {
       if (this.oldChecked !== checked && this.oldIndeterminate !== indeterminate) {
         this.tree.$emit('check-change', this.node.data, checked, indeterminate);
       }
       this.oldChecked = checked;
       this.oldIndeterminate = indeterminate;
     }
   },
   
   watch: {
     'node.checked'(val) {
       this.handleSelectChange(val, this.node.indeterminate);
     },
     'node.indeterminate'(val) {
       this.handleSelectChange(this.node.checked, val);
     }
   },
   
   data() {
     return {
       oldChecked: null,
       oldIndeterminate: null
     };
   }
   ```

7. **åœ¨ TreeStore ä¸­å®ç°å¤é€‰æ¡†ç›¸å…³æ–¹æ³•**ï¼š
   ```javascript
   // tree-store.js
   getCheckedNodes(leafOnly = false, includeHalfChecked = false) {
     const checkedNodes = [];
     const traverse = function(node) {
       const childNodes = node.root ? node.root.childNodes : node.childNodes;
       
       childNodes.forEach((child) => {
         if ((child.checked || (includeHalfChecked && child.indeterminate)) && 
             (!leafOnly || (leafOnly && child.isLeaf))) {
           checkedNodes.push(child.data);
         }
         traverse(child);
       });
     };
     
     traverse(this);
     return checkedNodes;
   }
   
   getCheckedKeys(leafOnly = false) {
     return this.getCheckedNodes(leafOnly).map((data) => (data || {})[this.key]);
   }
   
   getHalfCheckedNodes() {
     const nodes = [];
     const traverse = function(node) {
       const childNodes = node.root ? node.root.childNodes : node.childNodes;
       
       childNodes.forEach((child) => {
         if (child.indeterminate) {
           nodes.push(child.data);
         }
         traverse(child);
       });
     };
     
     traverse(this);
     return nodes;
   }
   
   getHalfCheckedKeys() {
     return this.getHalfCheckedNodes().map((data) => (data || {})[this.key]);
   }
   
   setChecked(data, checked, deep) {
     const node = this.getNode(data);
     if (node) {
       node.setChecked(!!checked, deep);
     }
   }
   
   _initDefaultCheckedNodes() {
     const defaultCheckedKeys = this.defaultCheckedKeys || [];
     const nodesMap = this.nodesMap;
     
     defaultCheckedKeys.forEach((checkedKey) => {
       const node = nodesMap[checkedKey];
       if (node) {
         node.setChecked(true, !this.checkStrictly);
       }
     });
   }
   
   // åœ¨ constructor æœ€åè°ƒç”¨
   this._initDefaultCheckedNodes();
   ```

8. **åœ¨ tree.vue ä¸­æä¾› API**ï¼š
   ```javascript
   // tree.vue
   methods: {
     getCheckedNodes(leafOnly, includeHalfChecked) {
       return this.store.getCheckedNodes(leafOnly, includeHalfChecked);
     },
     
     getCheckedKeys(leafOnly) {
       return this.store.getCheckedKeys(leafOnly);
     },
     
     setCheckedNodes(nodes, leafOnly) {
       if (!this.nodeKey) throw new Error('[Tree] nodeKey is required in setCheckedNodes');
       this.store.setCheckedNodes(nodes, leafOnly);
     },
     
     setCheckedKeys(keys, leafOnly) {
       if (!this.nodeKey) throw new Error('[Tree] nodeKey is required in setCheckedKeys');
       this.store.setCheckedKeys(keys, leafOnly);
     },
     
     setChecked(data, checked, deep) {
       this.store.setChecked(data, checked, deep);
     },
     
     getHalfCheckedNodes() {
       return this.store.getHalfCheckedNodes();
     },
     
     getHalfCheckedKeys() {
       return this.store.getHalfCheckedKeys();
     }
   }
   ```

### âŒ ä¸è¯¥åšä»€ä¹ˆ
- âŒ ä¸è¦å®ç° checkOnClickNodeï¼ˆç‚¹å‡»èŠ‚ç‚¹å‹¾é€‰ï¼‰
- âŒ ä¸è¦å®ç° checkDescendantsï¼ˆæ‡’åŠ è½½æ—¶çº§è”ï¼‰
- âŒ ä¸è¦å®ç°ç¦ç”¨èŠ‚ç‚¹çš„å¤é€‰æ¡†é€»è¾‘ç»†èŠ‚

### ğŸŒ¿ åˆ†æ”¯å‘½å
```bash
git checkout -b feature/tree-step8-checkbox
```

### âœ”ï¸ éªŒæ”¶æ ‡å‡†
- [ ] å¤é€‰æ¡†æ­£ç¡®æ˜¾ç¤º
- [ ] å‹¾é€‰çˆ¶èŠ‚ç‚¹ï¼Œå­èŠ‚ç‚¹å…¨éƒ¨å‹¾é€‰
- [ ] å‹¾é€‰æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹è‡ªåŠ¨å‹¾é€‰
- [ ] éƒ¨åˆ†å­èŠ‚ç‚¹å‹¾é€‰ï¼Œçˆ¶èŠ‚ç‚¹æ˜¾ç¤ºåŠé€‰çŠ¶æ€
- [ ] checkStrictly é…ç½®ç”Ÿæ•ˆï¼ˆçˆ¶å­ä¸å…³è”ï¼‰
- [ ] defaultCheckedKeys é…ç½®ç”Ÿæ•ˆ
- [ ] getCheckedNodesã€setCheckedKeys ç­‰ API å·¥ä½œæ­£å¸¸
- [ ] check å’Œ check-change äº‹ä»¶æ­£å¸¸è§¦å‘

---

## Step 9: å®ç°èŠ‚ç‚¹å¢åˆ æ”¹ï¼ˆæ¶æ„ - CRUD æ“ä½œï¼‰

### ğŸ“‹ æœ¬æ­¥ç›®æ ‡
å®ç°èŠ‚ç‚¹çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œæ”¯æŒåŠ¨æ€ä¿®æ”¹æ ‘ç»“æ„ã€‚

### âœ… è¦è¾¾åˆ°çš„æ•ˆæœ
- æ”¯æŒæ·»åŠ å­èŠ‚ç‚¹ï¼ˆappendï¼‰
- æ”¯æŒåœ¨æŒ‡å®šèŠ‚ç‚¹å‰åæ’å…¥ï¼ˆinsertBeforeã€insertAfterï¼‰
- æ”¯æŒåˆ é™¤èŠ‚ç‚¹ï¼ˆremoveï¼‰
- æ”¯æŒæ›´æ–°èŠ‚ç‚¹å­åˆ—è¡¨ï¼ˆupdateKeyChildrenï¼‰
- æ•°æ®å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°è§†å›¾

### ğŸ¯ è¯¥åšä»€ä¹ˆ
1. **åœ¨ Node ä¸­å®ç° insertBefore å’Œ insertAfter**ï¼š
   ```javascript
   // node.js
   insertBefore(child, ref) {
     let index;
     if (ref) {
       index = this.childNodes.indexOf(ref);
     }
     this.insertChild(child, index);
   }
   
   insertAfter(child, ref) {
     let index;
     if (ref) {
       index = this.childNodes.indexOf(ref);
       if (index !== -1) index += 1;
     }
     this.insertChild(child, index);
   }
   ```

2. **å®Œå–„ insertChild æ–¹æ³•**ï¼ˆåŒæ­¥åŸå§‹æ•°æ®ï¼‰ï¼š
   ```javascript
   // node.js
   insertChild(child, index, batch) {
     if (!child) throw new Error('insertChild error: child is required.');
     
     if (!(child instanceof Node)) {
       // åŒæ­¥åˆ°åŸå§‹æ•°æ®
       if (!batch) {
         const children = this.getChildren(true) || [];
         if (children.indexOf(child.data) === -1) {
           if (typeof index === 'undefined' || index < 0) {
             children.push(child.data);
           } else {
             children.splice(index, 0, child.data);
           }
         }
       }
       Object.assign(child, {
         parent: this,
         store: this.store
       });
       child = new Node(child);
     }
     
     child.level = this.level + 1;
     
     if (typeof index === 'undefined' || index < 0) {
       this.childNodes.push(child);
     } else {
       this.childNodes.splice(index, 0, child);
     }
     
     this.updateLeafState();
   }
   
   getChildren(forceInit = false) {
     if (this.level === 0) return this.data;
     const data = this.data;
     if (!data) return null;
     
     const props = this.store.props;
     let children = 'children';
     if (props) {
       children = props.children || 'children';
     }
     
     if (data[children] === undefined) {
       data[children] = null;
     }
     
     if (forceInit && !data[children]) {
       data[children] = [];
     }
     
     return data[children];
   }
   ```

3. **å®Œå–„ removeChild æ–¹æ³•**ï¼ˆåŒæ­¥åŸå§‹æ•°æ®ï¼‰ï¼š
   ```javascript
   // node.js
   removeChild(child) {
     const children = this.getChildren() || [];
     const dataIndex = children.indexOf(child.data);
     if (dataIndex > -1) {
       children.splice(dataIndex, 1);
     }
     
     const index = this.childNodes.indexOf(child);
     if (index > -1) {
       this.store && this.store.deregisterNode(child);
       child.parent = null;
       this.childNodes.splice(index, 1);
     }
     
     this.updateLeafState();
   }
   ```

4. **åœ¨ tree.vue ä¸­æä¾› API**ï¼š
   ```javascript
   // tree.vue
   methods: {
     append(data, parentNode) {
       this.store.append(data, parentNode);
     },
     
     insertBefore(data, refNode) {
       this.store.insertBefore(data, refNode);
     },
     
     insertAfter(data, refNode) {
       this.store.insertAfter(data, refNode);
     },
     
     remove(data) {
       this.store.remove(data);
     },
     
     updateKeyChildren(key, data) {
       if (!this.nodeKey) throw new Error('[Tree] nodeKey is required in updateKeyChild');
       this.store.updateChildren(key, data);
     }
   }
   ```

5. **åœ¨ TreeStore ä¸­å®ç° updateChildren**ï¼š
   ```javascript
   // tree-store.js
   updateChildren(key, data) {
     const node = this.nodesMap[key];
     if (!node) return;
     const childNodes = node.childNodes;
     for (let i = childNodes.length - 1; i >= 0; i--) {
       const child = childNodes[i];
       this.remove(child.data);
     }
     for (let i = 0, j = data.length; i < j; i++) {
       const child = data[i];
       this.append(child, node.data);
     }
   }
   ```

6. **ç›‘å¬ data å˜åŒ–**ï¼š
   ```javascript
   // tree.vue
   watch: {
     data(newVal) {
       this.store.setData(newVal);
     }
   }
   ```

7. **åœ¨ Node ä¸­å®ç° updateChildren**ï¼š
   ```javascript
   // node.js
   updateChildren() {
     const newData = this.getChildren() || [];
     const oldData = this.childNodes.map((node) => node.data);
     
     const newDataMap = {};
     const newNodes = [];
     
     newData.forEach((item, index) => {
       const key = item[NODE_KEY];
       const isNodeExists = !!key && oldData.findIndex(data => data[NODE_KEY] === key) >= 0;
       if (isNodeExists) {
         newDataMap[key] = { index, data: item };
       } else {
         newNodes.push({ index, data: item });
       }
     });
     
     if (!this.store.lazy) {
       oldData.forEach((item) => {
         if (!newDataMap[item[NODE_KEY]]) this.removeChildByData(item);
       });
     }
     
     newNodes.forEach(({ index, data }) => {
       this.insertChild({ data }, index);
     });
     
     this.updateLeafState();
   }
   
   removeChildByData(data) {
     let targetNode = null;
     for (let i = 0; i < this.childNodes.length; i++) {
       if (this.childNodes[i].data === data) {
         targetNode = this.childNodes[i];
         break;
       }
     }
     if (targetNode) {
       this.removeChild(targetNode);
     }
   }
   ```

8. **åœ¨ tree-node.vue ä¸­ç›‘å¬æ•°æ®å˜åŒ–**ï¼š
   ```javascript
   // tree-node.vue - created
   const props = tree.props || {};
   const childrenKey = props['children'] || 'children';
   
   this.$watch(`node.data.${childrenKey}`, () => {
     this.node.updateChildren();
   });
   ```

### âŒ ä¸è¯¥åšä»€ä¹ˆ
- âŒ ä¸è¦å®ç°æ‰¹é‡æ“ä½œçš„æ€§èƒ½ä¼˜åŒ–
- âŒ ä¸è¦å®ç°æ“ä½œå†å²è®°å½•ï¼ˆæ’¤é”€/é‡åšï¼‰
- âŒ ä¸è¦å®ç°èŠ‚ç‚¹æ‹–æ‹½æ’åº

### ğŸŒ¿ åˆ†æ”¯å‘½å
```bash
git checkout -b feature/tree-step9-crud
```

### âœ”ï¸ éªŒæ”¶æ ‡å‡†
- [ ] append å¯ä»¥æ·»åŠ å­èŠ‚ç‚¹
- [ ] insertBefore å’Œ insertAfter å¯ä»¥åœ¨æŒ‡å®šä½ç½®æ’å…¥èŠ‚ç‚¹
- [ ] remove å¯ä»¥åˆ é™¤èŠ‚ç‚¹
- [ ] updateKeyChildren å¯ä»¥æ›´æ–°èŠ‚ç‚¹çš„å­åˆ—è¡¨
- [ ] data prop å˜åŒ–æ—¶æ ‘è‡ªåŠ¨æ›´æ–°
- [ ] èŠ‚ç‚¹çš„åŸå§‹æ•°æ®å’Œ Node å®ä¾‹ä¿æŒåŒæ­¥

---

## Step 10: å®ç°æ‡’åŠ è½½åŠŸèƒ½ï¼ˆç»éªŒ - å¼‚æ­¥åŠ è½½ï¼‰

### ğŸ“‹ æœ¬æ­¥ç›®æ ‡
å®ç°æ ‘èŠ‚ç‚¹çš„æ‡’åŠ è½½åŠŸèƒ½ï¼Œæ”¯æŒå¼‚æ­¥åŠ è½½å­èŠ‚ç‚¹æ•°æ®ã€‚

### âœ… è¦è¾¾åˆ°çš„æ•ˆæœ
- å¼€å¯ lazy æ¨¡å¼åï¼Œåˆå§‹ä¸æ¸²æŸ“å­èŠ‚ç‚¹
- å±•å¼€èŠ‚ç‚¹æ—¶è°ƒç”¨ load æ–¹æ³•å¼‚æ­¥åŠ è½½æ•°æ®
- åŠ è½½è¿‡ç¨‹ä¸­æ˜¾ç¤º loading å›¾æ ‡
- åŠ è½½å®Œæˆåæ¸²æŸ“å­èŠ‚ç‚¹
- å¶å­èŠ‚ç‚¹ä¸è§¦å‘åŠ è½½

### ğŸ¯ è¯¥åšä»€ä¹ˆ
1. **æ·»åŠ æ‡’åŠ è½½ç›¸å…³ props**ï¼š
   ```javascript
   // tree.vue
   props: {
     lazy: {
       type: Boolean,
       default: false
     },
     load: Function
   }
   ```

2. **åœ¨ TreeStore ä¸­å¤„ç†æ‡’åŠ è½½åˆå§‹åŒ–**ï¼š
   ```javascript
   // tree-store.js - constructor
   if (this.lazy && this.load) {
     const loadFn = this.load;
     loadFn(this.root, (data) => {
       this.root.doCreateChildren(data);
       this._initDefaultCheckedNodes();
     });
   } else {
     this._initDefaultCheckedNodes();
   }
   ```

3. **åœ¨ Node ä¸­å®ç°æ‡’åŠ è½½é€»è¾‘**ï¼š
   ```javascript
   // node.js
   shouldLoadData() {
     return this.store.lazy === true && this.store.load && !this.loaded;
   }
   
   loadData(callback, defaultProps = {}) {
     if (this.store.lazy === true && this.store.load && !this.loaded && 
         (!this.loading || Object.keys(defaultProps).length)) {
       this.loading = true;
       
       const resolve = (children) => {
         this.childNodes = [];
         this.doCreateChildren(children, defaultProps);
         this.loaded = true;
         this.loading = false;
         this.updateLeafState();
         if (callback) {
           callback.call(this, children);
         }
       };
       
       this.store.load(this, resolve);
     } else {
       if (callback) {
         callback.call(this);
       }
     }
   }
   
   doCreateChildren(array, defaultProps = {}) {
     array.forEach((item) => {
       this.insertChild(Object.assign({ data: item }, defaultProps), undefined, true);
     });
   }
   ```

4. **ä¿®æ”¹ expand æ–¹æ³•æ”¯æŒæ‡’åŠ è½½**ï¼š
   ```javascript
   // node.js
   expand(callback, expandParent) {
     const done = () => {
       if (expandParent) {
         let parent = this.parent;
         while (parent.level > 0) {
           parent.expanded = true;
           parent = parent.parent;
         }
       }
       this.expanded = true;
       if (callback) callback();
     };
     
     if (this.shouldLoadData()) {
       this.loadData((data) => {
         if (data instanceof Array) {
           if (this.checked) {
             this.setChecked(true, true);
           } else if (!this.store.checkStrictly) {
             reInitChecked(this);
           }
           done();
         }
       });
     } else {
       done();
     }
   }
   ```

5. **åœ¨ tree-node.vue ä¸­æ˜¾ç¤º loading å›¾æ ‡**ï¼š
   ```vue
   <span
     v-if="node.loading"
     class="el-tree-node__loading-icon el-icon-loading"
   ></span>
   ```

6. **å¤„ç†æ‡’åŠ è½½æ—¶çš„å¶å­èŠ‚ç‚¹åˆ¤æ–­**ï¼š
   ```javascript
   // node.js - constructor
   const props = store.props;
   if (props && typeof props.isLeaf !== 'undefined') {
     const isLeaf = getPropertyFromData(this, 'isLeaf');
     if (typeof isLeaf === 'boolean') {
       this.isLeafByUser = isLeaf;
     }
   }
   
   // node.js
   updateLeafState() {
     if (this.store.lazy === true && this.loaded !== true && 
         typeof this.isLeafByUser !== 'undefined') {
       this.isLeaf = this.isLeafByUser;
       return;
     }
     const childNodes = this.childNodes;
     if (!this.store.lazy || (this.store.lazy === true && this.loaded === true)) {
       this.isLeaf = !childNodes || childNodes.length === 0;
       return;
     }
     this.isLeaf = false;
   }
   
   const getPropertyFromData = function(node, prop) {
     const props = node.store.props;
     const data = node.data || {};
     const config = props[prop];
     
     if (typeof config === 'function') {
       return config(data, node);
     } else if (typeof config === 'string') {
       return data[config];
     } else if (typeof config === 'undefined') {
       const dataProp = data[prop];
       return dataProp === undefined ? '' : dataProp;
     }
   };
   ```

7. **å¤„ç†æ‡’åŠ è½½æ—¶çš„é»˜è®¤å±•å¼€**ï¼š
   ```javascript
   // node.js - constructor
   if (this.level > 0 && store.lazy && store.defaultExpandAll) {
     this.expand();
   }
   ```

### âŒ ä¸è¯¥åšä»€ä¹ˆ
- âŒ ä¸è¦å®ç°åŠ è½½å¤±è´¥é‡è¯•æœºåˆ¶
- âŒ ä¸è¦å®ç°åŠ è½½ç¼“å­˜ç­–ç•¥
- âŒ ä¸è¦å®ç°é¢„åŠ è½½åŠŸèƒ½

### ğŸŒ¿ åˆ†æ”¯å‘½å
```bash
git checkout -b feature/tree-step10-lazy-load
```

### âœ”ï¸ éªŒæ”¶æ ‡å‡†
- [ ] æ‡’åŠ è½½æ¨¡å¼ä¸‹ï¼Œåˆå§‹ä¸åŠ è½½å­èŠ‚ç‚¹
- [ ] å±•å¼€èŠ‚ç‚¹æ—¶è°ƒç”¨ load æ–¹æ³•
- [ ] åŠ è½½è¿‡ç¨‹ä¸­æ˜¾ç¤º loading å›¾æ ‡
- [ ] åŠ è½½å®Œæˆåå­èŠ‚ç‚¹æ­£ç¡®æ¸²æŸ“
- [ ] isLeaf é…ç½®å¯ä»¥æ ‡è®°å¶å­èŠ‚ç‚¹
- [ ] æ‡’åŠ è½½æ—¶å¤é€‰æ¡†çº§è”é€»è¾‘æ­£ç¡®

---

## Step 11: å®ç°æ‹–æ‹½åŠŸèƒ½ï¼ˆç»éªŒ - åŸç”Ÿæ‹–æ‹½ APIï¼‰

### ğŸ“‹ æœ¬æ­¥ç›®æ ‡
å®ç°èŠ‚ç‚¹çš„æ‹–æ‹½æ’åºåŠŸèƒ½ï¼Œä½¿ç”¨ HTML5 Drag and Drop APIã€‚

### âœ… è¦è¾¾åˆ°çš„æ•ˆæœ
- èŠ‚ç‚¹å¯ä»¥æ‹–åŠ¨
- æ‹–åŠ¨æ—¶æ˜¾ç¤ºæ”¾ç½®æŒ‡ç¤ºå™¨ï¼ˆbefore/after/innerï¼‰
- æ”¾ç½®åˆ°ç›®æ ‡ä½ç½®æ—¶æ›´æ–°æ ‘ç»“æ„
- æ”¯æŒ allowDrag å’Œ allowDrop é…ç½®é™åˆ¶æ‹–æ‹½
- è§¦å‘æ‹–æ‹½ç›¸å…³äº‹ä»¶

### ğŸ¯ è¯¥åšä»€ä¹ˆ
1. **æ·»åŠ æ‹–æ‹½ç›¸å…³ props**ï¼š
   ```javascript
   // tree.vue
   props: {
     draggable: {
       type: Boolean,
       default: false
     },
     allowDrag: Function,
     allowDrop: Function
   },
   
   data() {
     return {
       dragState: {
         showDropIndicator: false,
         draggingNode: null,
         dropNode: null,
         allowDrop: true,
         dropType: null
       }
     };
   }
   ```

2. **åœ¨æ¨¡æ¿ä¸­æ·»åŠ æ‹–æ‹½æ ·å¼ç±»å’ŒæŒ‡ç¤ºå™¨**ï¼š
   ```vue
   <!-- tree.vue -->
   <div
     class="el-tree"
     :class="{
       'el-tree--highlight-current': highlightCurrent,
       'is-dragging': !!dragState.draggingNode,
       'is-drop-not-allow': !dragState.allowDrop,
       'is-drop-inner': dragState.dropType === 'inner'
     }"
     role="tree"
   >
     <!-- ... -->
     <div
       v-show="dragState.showDropIndicator"
       class="el-tree__drop-indicator"
       ref="dropIndicator"
     ></div>
   </div>
   ```

3. **åœ¨ tree-node.vue ä¸­æ·»åŠ æ‹–æ‹½äº‹ä»¶**ï¼š
   ```vue
   <div
     class="el-tree-node"
     :draggable="tree.draggable"
     @dragstart.stop="handleDragStart"
     @dragover.stop="handleDragOver"
     @dragend.stop="handleDragEnd"
     @drop.stop="handleDrop"
   >
   ```

4. **å®ç°æ‹–æ‹½äº‹ä»¶å¤„ç†æ–¹æ³•**ï¼š
   ```javascript
   // tree-node.vue
   methods: {
     handleDragStart(event) {
       if (!this.tree.draggable) return;
       this.tree.$emit('tree-node-drag-start', event, this);
     },
     
     handleDragOver(event) {
       if (!this.tree.draggable) return;
       this.tree.$emit('tree-node-drag-over', event, this);
       event.preventDefault();
     },
     
     handleDrop(event) {
       event.preventDefault();
     },
     
     handleDragEnd(event) {
       if (!this.tree.draggable) return;
       this.tree.$emit('tree-node-drag-end', event, this);
     }
   }
   ```

5. **åœ¨ tree.vue created ä¸­ç›‘å¬æ‹–æ‹½äº‹ä»¶**ï¼š
   ```javascript
   // tree.vue - created
   let dragState = this.dragState;
   
   // dragstart - å¼€å§‹æ‹–åŠ¨
   this.$on('tree-node-drag-start', (event, treeNode) => {
     if (typeof this.allowDrag === 'function' && !this.allowDrag(treeNode.node)) {
       event.preventDefault();
       return false;
     }
     event.dataTransfer.effectAllowed = 'move';
     
     try {
       event.dataTransfer.setData('text/plain', '');
     } catch (e) {}
     
     dragState.draggingNode = treeNode;
     this.$emit('node-drag-start', treeNode.node, event);
   });
   
   // dragover - æ‹–åŠ¨ç»è¿‡
   this.$on('tree-node-drag-over', (event, treeNode) => {
     const dropNode = findNearestComponent(event.target, 'ElTreeNode');
     const oldDropNode = dragState.dropNode;
     if (oldDropNode && oldDropNode !== dropNode) {
       removeClass(oldDropNode.$el, 'is-drop-inner');
     }
     
     const draggingNode = dragState.draggingNode;
     if (!draggingNode || !dropNode) return;
     
     let dropPrev = true;
     let dropInner = true;
     let dropNext = true;
     let userAllowDropInner = true;
     
     if (typeof this.allowDrop === 'function') {
       dropPrev = this.allowDrop(draggingNode.node, dropNode.node, 'prev');
       userAllowDropInner = dropInner = this.allowDrop(draggingNode.node, dropNode.node, 'inner');
       dropNext = this.allowDrop(draggingNode.node, dropNode.node, 'next');
     }
     
     event.dataTransfer.dropEffect = dropInner ? 'move' : 'none';
     
     if ((dropPrev || dropInner || dropNext) && oldDropNode !== dropNode) {
       if (oldDropNode) {
         this.$emit('node-drag-leave', draggingNode.node, oldDropNode.node, event);
       }
       this.$emit('node-drag-enter', draggingNode.node, dropNode.node, event);
     }
     
     if (dropPrev || dropInner || dropNext) {
       dragState.dropNode = dropNode;
     }
     
     // é˜²æ­¢éæ³•æ‹–æ‹½
     if (dropNode.node.nextSibling === draggingNode.node) {
       dropNext = false;
     }
     if (dropNode.node.previousSibling === draggingNode.node) {
       dropPrev = false;
     }
     if (dropNode.node.contains(draggingNode.node, false)) {
       dropInner = false;
     }
     if (draggingNode.node === dropNode.node || draggingNode.node.contains(dropNode.node)) {
       dropPrev = false;
       dropInner = false;
       dropNext = false;
     }
     
     // è®¡ç®—æ”¾ç½®ä½ç½®
     const targetPosition = dropNode.$el.getBoundingClientRect();
     const treePosition = this.$el.getBoundingClientRect();
     
     let dropType;
     const prevPercent = dropPrev ? (dropInner ? 0.25 : (dropNext ? 0.45 : 1)) : -1;
     const nextPercent = dropNext ? (dropInner ? 0.75 : (dropPrev ? 0.55 : 0)) : 1;
     
     let indicatorTop = -9999;
     const distance = event.clientY - targetPosition.top;
     
     if (distance < targetPosition.height * prevPercent) {
       dropType = 'before';
     } else if (distance > targetPosition.height * nextPercent) {
       dropType = 'after';
     } else if (dropInner) {
       dropType = 'inner';
     } else {
       dropType = 'none';
     }
     
     // æ›´æ–°æŒ‡ç¤ºå™¨ä½ç½®
     const iconPosition = dropNode.$el.querySelector('.el-tree-node__expand-icon').getBoundingClientRect();
     const dropIndicator = this.$refs.dropIndicator;
     
     if (dropType === 'before') {
       indicatorTop = iconPosition.top - treePosition.top;
     } else if (dropType === 'after') {
       indicatorTop = iconPosition.bottom - treePosition.top;
     }
     
     dropIndicator.style.top = indicatorTop + 'px';
     dropIndicator.style.left = (iconPosition.right - treePosition.left) + 'px';
     
     if (dropType === 'inner') {
       addClass(dropNode.$el, 'is-drop-inner');
     } else {
       removeClass(dropNode.$el, 'is-drop-inner');
     }
     
     dragState.showDropIndicator = dropType === 'before' || dropType === 'after';
     dragState.allowDrop = dragState.showDropIndicator || userAllowDropInner;
     dragState.dropType = dropType;
     this.$emit('node-drag-over', draggingNode.node, dropNode.node, event);
   });
   
   // dragend - æ‹–åŠ¨ç»“æŸ
   this.$on('tree-node-drag-end', (event) => {
     const { draggingNode, dropType, dropNode } = dragState;
     event.preventDefault();
     event.dataTransfer.dropEffect = 'move';
     
     if (draggingNode && dropNode) {
       const draggingNodeCopy = { data: draggingNode.node.data };
       if (dropType !== 'none') {
         draggingNode.node.remove();
       }
       if (dropType === 'before') {
         dropNode.node.parent.insertBefore(draggingNodeCopy, dropNode.node);
       } else if (dropType === 'after') {
         dropNode.node.parent.insertAfter(draggingNodeCopy, dropNode.node);
       } else if (dropType === 'inner') {
         dropNode.node.insertChild(draggingNodeCopy);
       }
       if (dropType !== 'none') {
         this.store.registerNode(draggingNodeCopy);
       }
       
       removeClass(dropNode.$el, 'is-drop-inner');
       
       this.$emit('node-drag-end', draggingNode.node, dropNode.node, dropType, event);
       if (dropType !== 'none') {
         this.$emit('node-drop', draggingNode.node, dropNode.node, dropType, event);
       }
     }
     if (draggingNode && !dropNode) {
       this.$emit('node-drag-end', draggingNode.node, null, dropType, event);
     }
     
     dragState.showDropIndicator = false;
     dragState.draggingNode = null;
     dragState.dropNode = null;
     dragState.allowDrop = true;
   });
   ```

6. **åœ¨ Node ä¸­å®ç° contains å’Œ sibling æ–¹æ³•**ï¼š
   ```javascript
   // node.js
   get nextSibling() {
     const parent = this.parent;
     if (parent) {
       const index = parent.childNodes.indexOf(this);
       if (index > -1) {
         return parent.childNodes[index + 1];
       }
     }
     return null;
   }
   
   get previousSibling() {
     const parent = this.parent;
     if (parent) {
       const index = parent.childNodes.indexOf(this);
       if (index > -1) {
         return index > 0 ? parent.childNodes[index - 1] : null;
       }
     }
     return null;
   }
   
   contains(target, deep = true) {
     const walk = function(parent) {
       const children = parent.childNodes || [];
       let result = false;
       for (let i = 0, j = children.length; i < j; i++) {
         const child = children[i];
         if (child === target || (deep && walk(child))) {
           result = true;
           break;
         }
       }
       return result;
     };
     
     return walk(this);
   }
   ```

7. **å¼•å…¥å¿…è¦çš„ä¾èµ–**ï¼š
   ```javascript
   // tree.vue
   import { findNearestComponent } from './model/util';
   import { addClass, removeClass } from 'element-ui/src/utils/dom';
   ```

### âŒ ä¸è¯¥åšä»€ä¹ˆ
- âŒ ä¸è¦å®ç°è·¨æ ‘æ‹–æ‹½
- âŒ ä¸è¦å®ç°æ‹–æ‹½åŠ¨ç”»æ•ˆæœ
- âŒ ä¸è¦å®ç°æ‹–æ‹½æ’¤é”€åŠŸèƒ½

### ğŸŒ¿ åˆ†æ”¯å‘½å
```bash
git checkout -b feature/tree-step11-drag-drop
```

### âœ”ï¸ éªŒæ”¶æ ‡å‡†
- [ ] èŠ‚ç‚¹å¯ä»¥æ‹–åŠ¨
- [ ] æ‹–åŠ¨æ—¶æ˜¾ç¤ºæ”¾ç½®æŒ‡ç¤ºå™¨
- [ ] å¯ä»¥æ”¾ç½®åˆ°èŠ‚ç‚¹å‰/å/å†…éƒ¨
- [ ] æ‹–æ‹½å®Œæˆåæ ‘ç»“æ„æ­£ç¡®æ›´æ–°
- [ ] allowDrag å’Œ allowDrop é…ç½®ç”Ÿæ•ˆ
- [ ] é˜²æ­¢éæ³•æ‹–æ‹½ï¼ˆæ‹–åˆ°è‡ªå·±æˆ–å­èŠ‚ç‚¹ï¼‰
- [ ] æ‹–æ‹½ç›¸å…³äº‹ä»¶æ­£å¸¸è§¦å‘

---

## Step 12: å®ç°é«˜çº§åŠŸèƒ½ï¼ˆæ¶æ„ - å®Œå–„ç»†èŠ‚ï¼‰

### ğŸ“‹ æœ¬æ­¥ç›®æ ‡
å®ç°æ ‘ç»„ä»¶çš„å…¶ä»–é«˜çº§åŠŸèƒ½ï¼ŒåŒ…æ‹¬è¿‡æ»¤ã€é”®ç›˜å¯¼èˆªã€è‡ªå®šä¹‰æ¸²æŸ“ç­‰ã€‚

### âœ… è¦è¾¾åˆ°çš„æ•ˆæœ
- æ”¯æŒèŠ‚ç‚¹è¿‡æ»¤åŠŸèƒ½
- æ”¯æŒé”®ç›˜å¯¼èˆªï¼ˆä¸Šä¸‹å·¦å³ã€å›è½¦ç©ºæ ¼ï¼‰
- æ”¯æŒè‡ªå®šä¹‰èŠ‚ç‚¹å†…å®¹æ¸²æŸ“
- æ”¯æŒæ‰‹é£ç´æ¨¡å¼
- æ”¯æŒå»¶è¿Ÿæ¸²æŸ“ä¼˜åŒ–
- æ”¯æŒæ— éšœç¢è®¿é—®

### ğŸ¯ è¯¥åšä»€ä¹ˆ
1. **å®ç°èŠ‚ç‚¹è¿‡æ»¤åŠŸèƒ½**ï¼š
   ```javascript
   // tree.vue
   props: {
     filterNodeMethod: Function
   },
   
   methods: {
     filter(value) {
       if (!this.filterNodeMethod) throw new Error('[Tree] filterNodeMethod is required when filter');
       this.store.filter(value);
     }
   }
   
   // tree-store.js
   filter(value) {
     const filterNodeMethod = this.filterNodeMethod;
     const traverse = function(node) {
       const childNodes = node.root ? node.root.childNodes : node.childNodes;
       
       childNodes.forEach((child) => {
         child.visible = filterNodeMethod.call(child, value, child.data, child);
         traverse(child);
       });
       
       if (!node.visible && childNodes.length) {
         let allHidden = true;
         allHidden = !childNodes.some(child => child.visible);
         
         if (node.root) {
           node.root.visible = allHidden === false;
         } else {
           node.visible = allHidden === false;
         }
       }
       if (!value) return;
       
       if (node.visible && !node.isLeaf && !this.lazy) node.expand();
     };
     
     traverse(this);
   }
   ```

2. **å®ç°é”®ç›˜å¯¼èˆª**ï¼š
   ```javascript
   // tree.vue
   data() {
     return {
       treeItems: null,
       checkboxItems: []
     };
   },
   
   computed: {
     treeItemArray() {
       return Array.prototype.slice.call(this.treeItems);
     }
   },
   
   methods: {
     initTabIndex() {
       this.treeItems = this.$el.querySelectorAll('.is-focusable[role=treeitem]');
       this.checkboxItems = this.$el.querySelectorAll('input[type=checkbox]');
       const checkedItem = this.$el.querySelectorAll('.is-checked[role=treeitem]');
       if (checkedItem.length) {
         checkedItem[0].setAttribute('tabindex', 0);
         return;
       }
       this.treeItems[0] && this.treeItems[0].setAttribute('tabindex', 0);
     },
     
     handleKeydown(ev) {
       const currentItem = ev.target;
       if (currentItem.className.indexOf('el-tree-node') === -1) return;
       const keyCode = ev.keyCode;
       this.treeItems = this.$el.querySelectorAll('.is-focusable[role=treeitem]');
       const currentIndex = this.treeItemArray.indexOf(currentItem);
       let nextIndex;
       
       if ([38, 40].indexOf(keyCode) > -1) { // upã€down
         ev.preventDefault();
         if (keyCode === 38) { // up
           nextIndex = currentIndex !== 0 ? currentIndex - 1 : 0;
         } else {
           nextIndex = (currentIndex < this.treeItemArray.length - 1) ? currentIndex + 1 : 0;
         }
         this.treeItemArray[nextIndex].focus();
       }
       
       if ([37, 39].indexOf(keyCode) > -1) { // leftã€right
         ev.preventDefault();
         currentItem.click();
       }
       
       const hasInput = currentItem.querySelector('[type="checkbox"]');
       if ([13, 32].indexOf(keyCode) > -1 && hasInput) { // space enter
         ev.preventDefault();
         hasInput.click();
       }
     }
   },
   
   mounted() {
     this.initTabIndex();
     this.$el.addEventListener('keydown', this.handleKeydown);
   },
   
   updated() {
     this.treeItems = this.$el.querySelectorAll('[role=treeitem]');
     this.checkboxItems = this.$el.querySelectorAll('input[type=checkbox]');
   },
   
   watch: {
     checkboxItems(val) {
       Array.prototype.forEach.call(val, (checkbox) => {
         checkbox.setAttribute('tabindex', -1);
       });
     }
   }
   ```

3. **åœ¨ tree-node.vue ä¸­æ·»åŠ æ— éšœç¢å±æ€§**ï¼š
   ```vue
   <div
     class="el-tree-node"
     :class="{
       'is-focusable': !node.disabled
     }"
     role="treeitem"
     tabindex="-1"
     :aria-expanded="expanded"
     :aria-disabled="node.disabled"
     :aria-checked="node.checked"
   >
   ```

4. **å®ç°è‡ªå®šä¹‰èŠ‚ç‚¹å†…å®¹**ï¼š
   ```javascript
   // tree.vue
   props: {
     renderContent: Function
   }
   
   // tree-node.vue
   props: {
     renderContent: Function
   },
   
   components: {
     NodeContent: {
       props: {
         node: {
           required: true
         }
       },
       render(h) {
         const parent = this.$parent;
         const tree = parent.tree;
         const node = this.node;
         const { data, store } = node;
         return (
           parent.renderContent
             ? parent.renderContent.call(parent._renderProxy, h, { _self: tree.$vnode.context, node, data, store })
             : tree.$scopedSlots.default
               ? tree.$scopedSlots.default({ node, data })
               : <span class="el-tree-node__label">{ node.label }</span>
         );
       }
     }
   }
   
   // åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨
   <node-content :node="node"></node-content>
   ```

5. **å®ç°æ‰‹é£ç´æ¨¡å¼**ï¼š
   ```javascript
   // tree.vue
   props: {
     accordion: Boolean
   }
   
   // tree-node.vue - created
   if (this.tree.accordion) {
     this.$on('tree-node-expand', node => {
       if (this.node !== node) {
         this.node.collapse();
       }
     });
   }
   
   // tree-node.vue - handleChildNodeExpand
   handleChildNodeExpand(nodeData, node, instance) {
     this.broadcast('ElTreeNode', 'tree-node-expand', node);
     this.tree.$emit('node-expand', nodeData, node, instance);
   }
   
   // éœ€è¦ emitter mixin
   import emitter from 'element-ui/src/mixins/emitter';
   
   export default {
     mixins: [emitter]
   }
   ```

6. **å®ç°å»¶è¿Ÿæ¸²æŸ“**ï¼š
   ```javascript
   // tree.vue
   props: {
     renderAfterExpand: {
       type: Boolean,
       default: true
     }
   }
   
   // tree-node.vue
   props: {
     renderAfterExpand: {
       type: Boolean,
       default: true
     }
   },
   
   data() {
     return {
       childNodeRendered: false
     };
   },
   
   watch: {
     'node.expanded'(val) {
       this.$nextTick(() => this.expanded = val);
       if (val) {
         this.childNodeRendered = true;
       }
     }
   },
   
   created() {
     if (this.node.expanded) {
       this.expanded = true;
       this.childNodeRendered = true;
     }
   }
   
   // æ¨¡æ¿
   <div
     class="el-tree-node__children"
     v-if="!renderAfterExpand || childNodeRendered"
     v-show="expanded"
   >
   ```

7. **å®ç°å…¶ä»–é…ç½®é¡¹**ï¼š
   ```javascript
   // tree.vue
   props: {
     indent: {
       type: Number,
       default: 18
     },
     iconClass: String,
     checkOnClickNode: Boolean,
     autoExpandParent: {
       type: Boolean,
       default: true
     },
     defaultExpandedKeys: Array
   },
   
   watch: {
     defaultExpandedKeys(newVal) {
       this.store.defaultExpandedKeys = newVal;
       this.store.setDefaultExpandedKeys(newVal);
     }
   }
   
   // tree-store.js
   setDefaultExpandedKeys(keys) {
     keys = keys || [];
     this.defaultExpandedKeys = keys;
     
     keys.forEach((key) => {
       const node = this.getNode(key);
       if (node) node.expand(null, this.autoExpandParent);
     });
   }
   
   // node.js - constructor
   const defaultExpandedKeys = store.defaultExpandedKeys;
   const key = store.key;
   if (key && defaultExpandedKeys && defaultExpandedKeys.indexOf(this.key) !== -1) {
     this.expand(null, store.autoExpandParent);
   }
   ```

8. **å®ç° checkOnClickNode**ï¼š
   ```javascript
   // tree-node.vue - handleClick
   if (this.tree.checkOnClickNode && !this.node.disabled) {
     this.handleCheckChange(null, {
       target: { checked: !this.node.checked }
     });
   }
   ```

9. **å®ç°å³é”®èœå•äº‹ä»¶**ï¼š
   ```javascript
   // tree-node.vue
   <div
     @contextmenu="($event) => this.handleContextMenu($event)"
   >
   
   methods: {
     handleContextMenu(event) {
       if (this.tree._events['node-contextmenu'] && 
           this.tree._events['node-contextmenu'].length > 0) {
         event.stopPropagation();
         event.preventDefault();
       }
       this.tree.$emit('node-contextmenu', event, this.node.data, this.node, this);
     }
   }
   ```

10. **å®ç° getNodePath æ–¹æ³•**ï¼š
    ```javascript
    // tree.vue
    methods: {
      getNodePath(data) {
        if (!this.nodeKey) throw new Error('[Tree] nodeKey is required in getNodePath');
        const node = this.store.getNode(data);
        if (!node) return [];
        const path = [node.data];
        let parent = node.parent;
        while (parent && parent !== this.root) {
          path.push(parent.data);
          parent = parent.parent;
        }
        return path.reverse();
      }
    }
    ```

### âŒ ä¸è¯¥åšä»€ä¹ˆ
- âŒ ä¸è¦å®ç°è™šæ‹Ÿæ»šåŠ¨
- âŒ ä¸è¦å®ç°èŠ‚ç‚¹æœç´¢é«˜äº®
- âŒ ä¸è¦å®ç°å›½é™…åŒ–

### ğŸŒ¿ åˆ†æ”¯å‘½å
```bash
git checkout -b feature/tree-step12-advanced
```

### âœ”ï¸ éªŒæ”¶æ ‡å‡†
- [ ] filter æ–¹æ³•å¯ä»¥è¿‡æ»¤èŠ‚ç‚¹
- [ ] é”®ç›˜å¯¼èˆªå·¥ä½œæ­£å¸¸ï¼ˆä¸Šä¸‹å·¦å³ã€å›è½¦ç©ºæ ¼ï¼‰
- [ ] renderContent å’Œ scoped slot è‡ªå®šä¹‰æ¸²æŸ“ç”Ÿæ•ˆ
- [ ] accordion æ‰‹é£ç´æ¨¡å¼ç”Ÿæ•ˆ
- [ ] renderAfterExpand å»¶è¿Ÿæ¸²æŸ“ç”Ÿæ•ˆ
- [ ] defaultExpandedKeys é»˜è®¤å±•å¼€ç”Ÿæ•ˆ
- [ ] checkOnClickNode é…ç½®ç”Ÿæ•ˆ
- [ ] node-contextmenu äº‹ä»¶è§¦å‘
- [ ] ARIA å±æ€§æ­£ç¡®è®¾ç½®ï¼Œæ”¯æŒæ— éšœç¢è®¿é—®

---

## Step 13: å®Œå–„æ ·å¼å’Œæ–‡æ¡£ï¼ˆæ¶æ„ - æ”¶å°¾å·¥ä½œï¼‰

### ğŸ“‹ æœ¬æ­¥ç›®æ ‡
å®Œå–„ç»„ä»¶æ ·å¼ï¼Œç¼–å†™ç»„ä»¶æ–‡æ¡£å’Œç¤ºä¾‹ï¼Œå®Œæˆæœ€ç»ˆæµ‹è¯•ã€‚

### âœ… è¦è¾¾åˆ°çš„æ•ˆæœ
- ç»„ä»¶æ ·å¼ä¸ ElementUI ä¿æŒä¸€è‡´
- æä¾›å®Œæ•´çš„ API æ–‡æ¡£
- æä¾›ä¸°å¯Œçš„ä½¿ç”¨ç¤ºä¾‹
- é€šè¿‡å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹

### ğŸ¯ è¯¥åšä»€ä¹ˆ
1. **ç¼–å†™æˆ–å¤åˆ¶æ ·å¼æ–‡ä»¶**ï¼š
   - å¤åˆ¶ `packages/theme-chalk/src/tree.scss`
   - ç¡®ä¿æ‰€æœ‰çŠ¶æ€çš„æ ·å¼éƒ½å·²å®šä¹‰

2. **ç¼–å†™ API æ–‡æ¡£**ï¼š
   ```markdown
   ## Tree Attributes
   | å‚æ•° | è¯´æ˜ | ç±»å‹ | å¯é€‰å€¼ | é»˜è®¤å€¼ |
   |-----|-----|------|-------|--------|
   | data | å±•ç¤ºæ•°æ® | array | â€” | â€” |
   | empty-text | å†…å®¹ä¸ºç©ºçš„æ—¶å€™å±•ç¤ºçš„æ–‡æœ¬ | String | â€” | â€” |
   | node-key | æ¯ä¸ªæ ‘èŠ‚ç‚¹ç”¨æ¥ä½œä¸ºå”¯ä¸€æ ‡è¯†çš„å±æ€§ | String | â€” | â€” |
   | props | é…ç½®é€‰é¡¹ | object | â€” | â€” |
   | ... | ... | ... | ... | ... |
   
   ## Tree Methods
   ## Tree Events
   ## Tree Scoped Slot
   ```

3. **ç¼–å†™ä½¿ç”¨ç¤ºä¾‹**ï¼š
   - åŸºç¡€ç”¨æ³•
   - å¯é€‰æ‹©
   - æ‡’åŠ è½½
   - è‡ªå®šä¹‰èŠ‚ç‚¹å†…å®¹
   - èŠ‚ç‚¹è¿‡æ»¤
   - æ‰‹é£ç´æ¨¡å¼
   - å¯æ‹–æ‹½èŠ‚ç‚¹

4. **ç¼–å†™å•å…ƒæµ‹è¯•**ï¼š
   - åŸºç¡€æ¸²æŸ“æµ‹è¯•
   - å±•å¼€æ”¶èµ·æµ‹è¯•
   - å¤é€‰æ¡†æµ‹è¯•
   - æ‹–æ‹½æµ‹è¯•
   - API æ–¹æ³•æµ‹è¯•

5. **æ€§èƒ½æµ‹è¯•**ï¼š
   - å¤§æ•°æ®é‡æ¸²æŸ“ï¼ˆ1000+ èŠ‚ç‚¹ï¼‰
   - æ‡’åŠ è½½æ€§èƒ½
   - æ‹–æ‹½æµç•…åº¦

6. **å…¼å®¹æ€§æµ‹è¯•**ï¼š
   - Chromeã€Firefoxã€Safariã€Edge
   - ç§»åŠ¨ç«¯æµè§ˆå™¨

7. **ä»£ç æ£€æŸ¥**ï¼š
   - ESLint æ£€æŸ¥é€šè¿‡
   - ä»£ç æ ¼å¼ç»Ÿä¸€
   - ç§»é™¤ console å’Œè°ƒè¯•ä»£ç 
   - æ·»åŠ å¿…è¦çš„æ³¨é‡Š

### âŒ ä¸è¯¥åšä»€ä¹ˆ
- âŒ ä¸è¦ä¿®æ”¹æ ¸å¿ƒé€»è¾‘
- âŒ ä¸è¦æ·»åŠ æ–°åŠŸèƒ½
- âŒ ä¸è¦è¿‡åº¦ä¼˜åŒ–

### ğŸŒ¿ åˆ†æ”¯å‘½å
```bash
git checkout -b feature/tree-step13-polish
```

### âœ”ï¸ éªŒæ”¶æ ‡å‡†
- [ ] æ ·å¼å®Œæ•´ä¸”ç¾è§‚
- [ ] API æ–‡æ¡£è¯¦ç»†å‡†ç¡®
- [ ] ç¤ºä¾‹ä»£ç å¯è¿è¡Œ
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] æ‰€æœ‰æµè§ˆå™¨å…¼å®¹
- [ ] ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡
- [ ] åŠŸèƒ½ä¸ ElementUI Tree 100% ä¸€è‡´

---

## æ€»ç»“

é€šè¿‡ä»¥ä¸Š 13 ä¸ªæ­¥éª¤ï¼Œä½ å°†å®Œæ•´åœ°å¤åˆ»å‡º ElementUI çš„ Tree ç»„ä»¶ã€‚æ•´ä¸ªå¤åˆ»è¿‡ç¨‹ä¸¥æ ¼éµå¾ªï¼š

### ğŸ—ï¸ æ¶æ„ç»´åº¦
- **Step 1-5**ï¼šæ­å»ºç»„ä»¶æ¶æ„ï¼ˆç›®å½•ç»“æ„ã€ç»„ä»¶åˆ†å±‚ã€é€’å½’æ¸²æŸ“ï¼‰
- **Step 6-7**ï¼šå®ç°äº¤äº’é€»è¾‘ï¼ˆå±•å¼€æ”¶èµ·ã€èŠ‚ç‚¹é€‰ä¸­ï¼‰
- **Step 12**ï¼šå®Œå–„é«˜çº§åŠŸèƒ½ï¼ˆè¿‡æ»¤ã€é”®ç›˜å¯¼èˆªã€è‡ªå®šä¹‰æ¸²æŸ“ï¼‰

### ğŸ—‚ï¸ æ•°æ®ç»“æ„ç»´åº¦
- **Step 2-3**ï¼šæ„å»ºæ•°æ®æ¨¡å‹ï¼ˆNode ç±»ã€TreeStore ç±»ï¼‰
- **Step 4**ï¼šå®ç°å·¥å…·å‡½æ•°ï¼ˆèŠ‚ç‚¹æ ‡è®°ã€key è·å–ï¼‰
- **Step 9**ï¼šå®ç°èŠ‚ç‚¹å¢åˆ æ”¹ï¼ˆCRUD æ“ä½œï¼‰

### ğŸ’¡ ç»éªŒç»´åº¦
- **Step 8**ï¼šå®ç°å¤é€‰æ¡†çº§è”ç®—æ³•
- **Step 10**ï¼šå®ç°æ‡’åŠ è½½æœºåˆ¶
- **Step 11**ï¼šå®ç°åŸç”Ÿæ‹–æ‹½ API

### ğŸ¯ æœ€ä½³å®è·µ
1. **æ¯ä¸€æ­¥éƒ½å¯ç‹¬ç«‹è¿è¡Œå’Œæµ‹è¯•**
2. **å¾ªåºæ¸è¿›ï¼Œé¿å…ä¸€æ¬¡æ€§å®ç°æ‰€æœ‰åŠŸèƒ½**
3. **å…ˆå®ç°æ ¸å¿ƒï¼Œå†å®Œå–„ç»†èŠ‚**
4. **é‡è§†æ•°æ®æ¨¡å‹è®¾è®¡ï¼Œè§†å›¾åªæ˜¯æ•°æ®çš„æ˜ å°„**
5. **å……åˆ†æµ‹è¯•æ¯ä¸€æ­¥çš„åŠŸèƒ½å®Œæ•´æ€§**

é€šè¿‡è¿™ä¸ªå¤åˆ»è¿‡ç¨‹ï¼Œä½ ä¸ä»…èƒ½å¾—åˆ°ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ Tree ç»„ä»¶ï¼Œæ›´é‡è¦çš„æ˜¯æ·±åˆ»ç†è§£ç»„ä»¶è®¾è®¡çš„æ€æƒ³å’Œå®ç°ç»†èŠ‚ã€‚
